<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Marks Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>Student Marks Manager</h1>
        
        <div class="labs-section">
            <h2>Labs</h2>
            <div class="labs-container">
                <div id="labsList"></div>
                <div class="create-lab">
                    <input type="text" id="newLabName" placeholder="Enter new lab name...">
                    <button onclick="createLab()"><i class="fas fa-plus"></i> Create Lab</button>
                </div>
            </div>
        </div>

        <div class="mark-input-section" id="markInputSection" style="display: none;">
            <h2>Add Mark</h2>
            <div class="mark-input-container">
                <p>Student: <span id="selectedStudentName"></span></p>
                <p>Lab: <span id="selectedLabName"></span></p>
                <input type="number" id="markValue" min="0" max="100" placeholder="Enter mark (0-100)">
                <button onclick="submitMark()">Submit Mark</button>
            </div>
        </div>
        
        <div class="student-section">
            <div class="create-student">
                <input type="text" id="newStudentName" placeholder="Enter student name...">
                <button onclick="createStudent()"><i class="fas fa-user-plus"></i> Add Student</button>
            </div>
            
            <div class="student-select-section">
                <select id="studentSelect" onchange="handleStudentSelect(this)">
                    <option value="">Select a student...</option>
                </select>
            </div>
        </div>

        <div class="marks-section" id="marksSection" style="display: none;">
            <h2>Current Marks for: <span id="selectedStudentName"></span></h2>
            
            <div class="current-marks">
                <h3>Current Marks</h3>
                <div id="marksTable"></div>
            </div>
        </div>

        <div class="students-table-section">
            <h2>All Students</h2>
            <div class="table-container">
                <table id="studentsTable">
                    <thead>
                        <tr id="tableHeader">
                            <th>Student Name</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Load the students table when page loads
        window.addEventListener('load', loadStudentsTable);
        
        async function loadStudentsTable() {
            const [studentsResponse, labsResponse] = await Promise.all([
                fetch('/api/all_students_marks'),
                fetch('/api/labs')
            ]);
            
            const studentsData = await studentsResponse.json();
            const labs = await labsResponse.json();
            
            // Set up table header with lab columns
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = '<th>Student Name</th>';
            labs.forEach(lab => {
                headerRow.innerHTML += `<th>${lab.lab_name}</th>`;
            });
            
            // Fill table body
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            studentsData.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${student.name}</td>`;
                
                labs.forEach(lab => {
                    const mark = student.marks[lab.lab_name];
                    row.innerHTML += `<td>${mark !== null ? mark + '%' : '-'}</td>`;
                });
                
                tableBody.appendChild(row);
            });
        }
        
        let selectedStudentId = null;
        
        async function createStudent() {
            const studentName = document.getElementById('newStudentName').value.trim();
            
            if (!studentName) {
                alert('Please enter a student name');
                return;
            }
            
            const response = await fetch('/api/students', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: studentName
                })
            });
            
            if (response.ok) {
                document.getElementById('newStudentName').value = '';
                await loadStudentsDropdown();
                alert('Student created successfully');
            } else {
                const error = await response.json();
                alert(error.message || 'Failed to create student');
            }
        }
        
        // Load labs when page loads
        window.addEventListener('load', loadLabs);
        
        async function loadLabs() {
            const response = await fetch('/api/labs');
            const labs = await response.json();
            
            const labsHtml = labs.map(lab => 
                `<div class="lab-item" onclick="selectLab(this, '${lab.lab_name}')">
                    ${lab.lab_name}
                </div>`
            ).join('');
            
            document.getElementById('labsList').innerHTML = labsHtml || '<p>No labs created yet.</p>';
            
            // Update the lab assignment dropdown
            const labSelect = document.getElementById('labAssignment');
            labSelect.innerHTML = labs.map(lab => 
                `<option value="${lab.lab_name}">${lab.lab_name}</option>`
            ).join('');
        }
        
        let selectedLabName = null;

        function selectLab(element, labName) {
            // Remove selected class from all labs
            document.querySelectorAll('.lab-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Add selected class to clicked lab
            element.classList.add('selected');
            selectedLabName = labName;
            
            // Show mark input section if both student and lab are selected
            updateMarkInputVisibility();
        }

        function updateMarkInputVisibility() {
            const markInputSection = document.getElementById('markInputSection');
            if (selectedStudentId && selectedLabName) {
                markInputSection.style.display = 'block';
                document.getElementById('selectedLabName').textContent = selectedLabName;
            } else {
                markInputSection.style.display = 'none';
            }
        }

        async function submitMark() {
            if (!selectedStudentId || !selectedLabName) {
                alert('Please select both a student and a lab');
                return;
            }

            const markInput = document.getElementById('markValue');
            const mark = parseInt(markInput.value);

            if (isNaN(mark) || mark < 0 || mark > 100) {
                alert('Please enter a valid mark between 0 and 100');
                return;
            }

            const response = await fetch('/api/add_mark', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    student_id: selectedStudentId,
                    lab_name: selectedLabName,
                    mark: mark
                })
            });

            if (response.ok) {
                markInput.value = '';
                await loadMarks(selectedStudentId);
                await loadStudentsTable();
                alert('Mark submitted successfully');
            } else {
                alert('Failed to add mark');
            }
        }

        async function createLab() {
            const labName = document.getElementById('newLabName').value.trim();
            
            if (!labName) {
                alert('Please enter a lab name');
                return;
            }
            
            const response = await fetch('/api/labs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    lab_name: labName
                })
            });
            
            if (response.ok) {
                document.getElementById('newLabName').value = '';
                await loadLabs();
            } else {
                const error = await response.json();
                alert(error.message || 'Failed to create lab');
            }
        }

        // Load students dropdown when page loads
        window.addEventListener('load', loadStudentsDropdown);
        
        async function loadStudentsDropdown() {
            const response = await fetch('/api/students');
            const students = await response.json();
            
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">Select a student...</option>' +
                students.map(student => 
                    `<option value="${student.student_id}" data-name="${student.name}">
                        ${student.name}
                    </option>`
                ).join('');
        }

        function handleStudentSelect(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            if (selectedOption.value) {
                selectStudent(
                    parseInt(selectedOption.value), 
                    selectedOption.dataset.name
                );
            }
        }

        async function selectStudent(studentId, name) {
            selectedStudentId = studentId;
            document.getElementById('selectedStudentName').textContent = name;
            document.getElementById('marksSection').style.display = 'block';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('studentSearch').value = name;
            
            // Load existing marks
            await loadMarks(studentId);
        }

        async function loadMarks(studentId) {
            const response = await fetch(`/api/get_marks/${studentId}`);
            const marks = await response.json();
            
            const marksHtml = marks.map(mark => 
                `<div class="mark-row">
                    <span>${mark.lab_name}: ${mark.mark}%</span>
                </div>`
            ).join('');
            
            document.getElementById('marksTable').innerHTML = marksHtml || '<p>No marks recorded yet.</p>';
        }

        async function addMark() {
            if (!selectedStudentId) return;

            const labName = document.getElementById('labAssignment').value;
            const mark = document.getElementById('markInput').value;

            if (!mark) {
                alert('Please enter a mark');
                return;
            }

            const response = await fetch('/api/add_mark', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    student_id: selectedStudentId,
                    lab_name: labName,
                    mark: parseInt(mark)
                })
            });

            if (response.ok) {
                document.getElementById('markInput').value = '';
                await loadMarks(selectedStudentId);
            }
        }
    </script>
</body>
</html>
